name: Postman CI/CD Pipeline

# Workflow Logic:
# 1. On push to feature branches: Run spec-lint ‚Üí functional-tests (using feature branch code)
# 2. On push to main (when PR is merged): Run spec-lint ‚Üí functional-tests ‚Üí push-to-postman (using merged main code)

on:
  push:
    branches:
      - '**'  # Trigger on all branches (including main when PR is merged)

jobs:
  # Job 1: Spec Lint - Validates API schema on all branches
  spec-lint:
    name: Spec Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Lint API Specifications
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          # Lint all collections
          echo "Linting Open API Spec containeing all APIs..."
          postman spec lint openapi.json
          
  # Job 2: Functional Tests - Runs Postman collections on all branches (depends on spec-lint)
  functional-tests:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: [spec-lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Application Dependencies
        run: |
          echo "Installing application dependencies..."
          yarn install
      
      - name: Build Application
        run: |
          echo "Building NestJS application..."
          yarn build
      
      - name: Start NestJS Application
        run: |
          echo "Starting NestJS application..."
          yarn start &
          
          # Wait for the application to be ready
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/ > /dev/null; then
              echo "‚úÖ Application is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify the application is running
          curl http://localhost:3000/ || (echo "‚ùå Application failed to start" && exit 1)
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Run Collection Tests
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          # Run Inventory Management API tests
          echo "Running Inventory Management API tests..."
          postman collection run postman/collections/Inventory-Management-API-Updated.postman_collection.json \
            -e postman/environments/Localhost.postman_environment.json \
            -r cli,json
          
          # Run Customer Feedback API tests
          echo "Running Customer Feedback API tests..."
          postman collection run postman/collections/Customer-Feedback-API.postman_collection.json \
            -e postman/environments/Localhost.postman_environment.json \
            -r cli,json
      
  # Job 3: Push to Postman - Runs only on main branch after successful tests
  push-to-postman:
    name: Push to Postman Workspace (Only on Main Branch)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [functional-tests]
    
    steps:
      - name: Check if deployment should run
        run: |
          echo "‚ÑπÔ∏è  This job only runs when code is pushed to main branch"
          echo "Current branch: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Push Collections to Postman Workspace
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          # Push all changes to Postman Workspace
          echo "Pushing all changes to Postman workspace..."
          postman workspace push --yes
          echo "‚úÖ Successfully pushed all changes to Postman workspace!"
      
      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Pipeline completed successfully!"
          echo "‚úÖ All tests passed"
          echo "‚úÖ All changes pushed to Postman workspace"
